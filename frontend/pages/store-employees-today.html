<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Employees Today ‚Äî TimeTrack</title>
    <link rel="stylesheet" href="static/css/style.css">
</head>
<body>
    <div class="navbar">
        <div class="nav-left">
            <div class="logo">‚è∞ TimeTrack</div>
            <nav class="nav-links">
                <a href="manager.html">Manager Dashboard</a>
            </nav>
        </div>
        <div class="nav-right">
            <a href="#" class="btn-logout" onclick="logoutApp()">Logout</a>
        </div>
    </div>
    <div class="container">
        <h2 id="storeTitle">Employees Working Today</h2>
        <div style="margin-top:12px">
            <button id="backBtn" class="bulk-update-btn" style="background:#6c757d">‚Üê Back to Stores</button>
            <button id="viewHistoryBtn" class="bulk-update-btn" style="background:#007bff">View Employee History</button>
            <button id="refreshBtn" class="bulk-update-btn" style="background:#28a745">üîÑ Refresh</button>
        </div>
        <div id="employeesTodayList" style="margin-top:20px"></div>
    </div>
    <script src="static/js/script.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', async () => {
        const urlParams = new URLSearchParams(window.location.search);
        const storeName = urlParams.get('store') || 'Store';
        
        const storeTitle = document.getElementById('storeTitle');
        const backBtn = document.getElementById('backBtn');
        const viewHistoryBtn = document.getElementById('viewHistoryBtn');
        const refreshBtn = document.getElementById('refreshBtn');
        const employeesTodayList = document.getElementById('employeesTodayList');
        
        if (storeTitle) {
          storeTitle.textContent = `${storeName} ‚Äî Employees Today`;
        }
        
        if (backBtn) {
          backBtn.addEventListener('click', () => {
            window.location = 'manager.html';
          });
        }
        
        if (viewHistoryBtn) {
          viewHistoryBtn.addEventListener('click', () => {
            window.location = `store-employees-history.html?store=${encodeURIComponent(storeName)}`;
          });
        }
        
        async function loadEmployeesToday() {
          try {
            if (!employeesTodayList) return;
            
            employeesTodayList.innerHTML = '<div style="text-align:center;padding:40px;color:#6c757d;">Loading...</div>';
            
            const response = await fetch(`/api/timeclock/today?store_id=${encodeURIComponent(storeName)}`);
            const data = await response.json();
            
            if (!response.ok) {
              throw new Error(data.error || 'Failed to load employees');
            }
            
            if (!data.employees || data.employees.length === 0) {
              employeesTodayList.innerHTML = '<div class="no-data" style="text-align:center;padding:40px;color:#6c757d;">No employees clocked in today.</div>';
              return;
            }
            
            const dateStr = new Date(data.date).toLocaleDateString('en-US', {
              weekday: 'long',
              year: 'numeric',
              month: 'long',
              day: 'numeric'
            });
            
            let html = `<div style="margin-bottom:20px;padding:16px;background:#f8f9fa;border-radius:8px;">
              <h3 style="margin:0;color:#2c3e50;">üìÖ ${dateStr}</h3>
              <p style="margin:8px 0 0 0;color:#6c757d;">Total Entries: ${data.total_count}</p>
            </div>`;
            
            html += '<div style="display:grid;gap:16px;">';
            
            data.employees.forEach(emp => {
              const clockInTime = new Date(emp.clock_in);
              const clockInStr = clockInTime.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
              });
              
              let clockOutStr = 'Active';
              let hoursStr = '';
              let statusColor = '#28a745';
              let statusIcon = 'üü¢';
              let statusText = 'Clocked In';
              let statusBadge = '<span style="background:#d4edda;color:#155724;padding:4px 12px;border-radius:12px;font-size:0.85rem;font-weight:600;">Active</span>';
              
              if (emp.clock_out) {
                const clockOutTime = new Date(emp.clock_out);
                clockOutStr = clockOutTime.toLocaleTimeString('en-US', {
                  hour: '2-digit',
                  minute: '2-digit',
                  hour12: true
                });
                const hours = emp.hours_worked || 0;
                hoursStr = `${hours.toFixed(2)} hrs`;
                statusColor = '#6c757d';
                statusIcon = '‚ö™';
                statusText = 'Clocked Out';
                statusBadge = '<span style="background:#e9ecef;color:#495057;padding:4px 12px;border-radius:12px;font-size:0.85rem;font-weight:600;">Clocked Out</span>';
              }
              
              const confidenceIn = emp.clock_in_confidence ? `${(emp.clock_in_confidence * 100).toFixed(0)}%` : 'N/A';
              const confidenceOut = emp.clock_out_confidence ? `${(emp.clock_out_confidence * 100).toFixed(0)}%` : 'N/A';
              
              html += `
                <div style="background:white;padding:20px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.1);border-left:4px solid ${statusColor};">
                  <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px;">
                    <div style="flex:1;">
                      <h3 style="margin:0 0 8px 0;color:#2c3e50;font-size:1.3rem;">
                        ${statusIcon} ${emp.employee_name || 'Unknown'}
                      </h3>
                      <div style="margin-bottom:4px;">${statusBadge}</div>
                    </div>
                    <div style="text-align:right;">
                      ${hoursStr ? `<div style="font-size:1.8rem;font-weight:700;color:#007bff;margin-bottom:4px;">${hoursStr}</div><div style="color:#6c757d;font-size:0.85rem;">Working Hours</div>` : `<div style="font-size:1rem;font-weight:600;color:#28a745;">Currently Active</div>`}
                    </div>
                  </div>
                  
                  <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;padding:12px;background:#f8f9fa;border-radius:8px;">
                    <div>
                      <div style="color:#6c757d;font-size:0.85rem;margin-bottom:4px;">Clock In</div>
                      <div style="color:#2c3e50;font-weight:600;">${clockInStr}</div>
                      <div style="color:#6c757d;font-size:0.8rem;margin-top:2px;">Confidence: ${confidenceIn}</div>
                    </div>
                    <div>
                      <div style="color:#6c757d;font-size:0.85rem;margin-bottom:4px;">Clock Out</div>
                      <div style="color:#2c3e50;font-weight:600;">${clockOutStr}</div>
                      ${emp.clock_out ? `<div style="color:#6c757d;font-size:0.8rem;margin-top:2px;">Confidence: ${confidenceOut}</div>` : ''}
                    </div>
                  </div>
                </div>
              `;
            });
            
            html += '</div>';
            
            employeesTodayList.innerHTML = html;
            
          } catch (error) {
            console.error('Error loading employees today:', error);
            if (employeesTodayList) {
              employeesTodayList.innerHTML = '<div class="no-data" style="text-align:center;padding:40px;color:#dc3545;">Failed to load employees. Please try again.</div>';
            }
          }
        }
        
        if (refreshBtn) {
          refreshBtn.addEventListener('click', loadEmployeesToday);
        }
        
        // Load data
        loadEmployeesToday();
        
        // Auto-refresh every 30 seconds
        setInterval(loadEmployeesToday, 30000);
      });
    </script>
</body>
</html>
