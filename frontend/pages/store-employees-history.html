<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Employee History ‚Äî TimeTrack</title>
    <link rel="stylesheet" href="static/css/style.css">
</head>
<body>
    <div class="navbar">
        <div class="nav-left">
            <div class="logo">‚è∞ TimeTrack</div>
            <nav class="nav-links">
                <a href="manager.html">Manager Dashboard</a>
            </nav>
        </div>
        <div class="nav-right">
            <a href="#" class="btn-logout" onclick="logoutApp()">Logout</a>
        </div>
    </div>
    <div class="container">
        <h2 id="storeTitle">Employee Attendance History</h2>
        <div style="margin-top:12px;display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
            <button id="backBtn" class="bulk-update-btn" style="background:#6c757d">‚Üê Back to Today</button>
            <select id="daysFilter" style="padding:8px 16px;border-radius:8px;border:1px solid #dee2e6;font-size:1rem;">
              <option value="7">Last 7 Days</option>
              <option value="30" selected>Last 30 Days</option>
              <option value="60">Last 60 Days</option>
              <option value="90">Last 90 Days</option>
            </select>
            <button id="refreshBtn" class="bulk-update-btn" style="background:#28a745">üîÑ Refresh</button>
        </div>
        <div id="employeesHistoryList" style="margin-top:20px"></div>
    </div>
    <script src="static/js/script.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', async () => {
        const urlParams = new URLSearchParams(window.location.search);
        const storeName = urlParams.get('store') || 'Store';
        
        const storeTitle = document.getElementById('storeTitle');
        const backBtn = document.getElementById('backBtn');
        const daysFilter = document.getElementById('daysFilter');
        const refreshBtn = document.getElementById('refreshBtn');
        const employeesHistoryList = document.getElementById('employeesHistoryList');
        
        if (storeTitle) {
          storeTitle.textContent = `${storeName} ‚Äî Attendance History`;
        }
        
        if (backBtn) {
          backBtn.addEventListener('click', () => {
            window.location = `store-employees-today.html?store=${encodeURIComponent(storeName)}`;
          });
        }
        
        async function loadEmployeesHistory() {
          try {
            if (!employeesHistoryList) return;
            
            const days = daysFilter ? parseInt(daysFilter.value) : 30;
            
            employeesHistoryList.innerHTML = '<div style="text-align:center;padding:40px;color:#6c757d;">Loading...</div>';
            
            const response = await fetch(`/api/timeclock/history?store_id=${encodeURIComponent(storeName)}&days=${days}`);
            const data = await response.json();
            
            if (!response.ok) {
              throw new Error(data.error || 'Failed to load history');
            }
            
            if (!data.entries || data.entries.length === 0) {
              employeesHistoryList.innerHTML = '<div class="no-data" style="text-align:center;padding:40px;color:#6c757d;">No attendance records found.</div>';
              return;
            }
            
            let html = `<div style="margin-bottom:20px;padding:16px;background:#f8f9fa;border-radius:8px;">
              <h3 style="margin:0;color:#2c3e50;">üìä Attendance Records</h3>
              <p style="margin:8px 0 0 0;color:#6c757d;">Total Entries: ${data.total_count} (Last ${days} days)</p>
            </div>`;
            
            html += '<div style="display:grid;gap:12px;">';
            
            // Group by date
            const groupedByDate = {};
            data.entries.forEach(entry => {
              const date = new Date(entry.clock_in).toLocaleDateString('en-US');
              if (!groupedByDate[date]) {
                groupedByDate[date] = [];
              }
              groupedByDate[date].push(entry);
            });
            
            // Sort dates descending
            const sortedDates = Object.keys(groupedByDate).sort((a, b) => new Date(b) - new Date(a));
            
            sortedDates.forEach(date => {
              const entries = groupedByDate[date];
              const dateObj = new Date(date);
              const dateStr = dateObj.toLocaleDateString('en-US', {
                weekday: 'short',
                year: 'numeric',
                month: 'short',
                day: 'numeric'
              });
              
              html += `
                <div style="background:white;padding:20px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
                  <h3 style="margin:0 0 16px 0;color:#2c3e50;font-size:1.2rem;border-bottom:2px solid #e9ecef;padding-bottom:8px;">
                    üìÖ ${dateStr}
                  </h3>
                  <div style="display:grid;gap:12px;">
              `;
              
              entries.forEach(emp => {
                const clockInTime = new Date(emp.clock_in);
                const clockInStr = clockInTime.toLocaleTimeString('en-US', {
                  hour: '2-digit',
                  minute: '2-digit',
                  hour12: true
                });
                
                let clockOutStr = 'Not Clocked Out';
                let hoursStr = '';
                let statusColor = '#ffc107';
                
                if (emp.clock_out) {
                  const clockOutTime = new Date(emp.clock_out);
                  clockOutStr = clockOutTime.toLocaleTimeString('en-US', {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: true
                  });
                  hoursStr = emp.hours_worked ? `${emp.hours_worked} hrs` : '';
                  statusColor = '#28a745';
                }
                
                html += `
                  <div style="padding:12px;background:#f8f9fa;border-radius:8px;border-left:3px solid ${statusColor};">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                      <div style="flex:1;">
                        <div style="font-weight:600;color:#2c3e50;margin-bottom:4px;">
                          <a href="employee-activities.html${emp.employee_id ? '?employeeId=' + emp.employee_id : ''}" style="color:#007bff;text-decoration:none;cursor:pointer;" 
                             onmouseover="this.style.textDecoration='underline'" 
                             onmouseout="this.style.textDecoration='none'">
                            ${emp.employee_name || 'Unknown'}
                          </a>
                        </div>
                        <div style="font-size:0.9rem;color:#6c757d;">
                          In: ${clockInStr} | Out: ${clockOutStr}
                        </div>
                      </div>
                      ${hoursStr ? `<div style="font-weight:700;color:#007bff;font-size:1.1rem;">${hoursStr}</div>` : ''}
                    </div>
                  </div>
                `;
              });
              
              html += `
                  </div>
                </div>
              `;
            });
            
            html += '</div>';
            
            employeesHistoryList.innerHTML = html;
            
          } catch (error) {
            console.error('Error loading employees history:', error);
            if (employeesHistoryList) {
              employeesHistoryList.innerHTML = '<div class="no-data" style="text-align:center;padding:40px;color:#dc3545;">Failed to load history. Please try again.</div>';
            }
          }
        }
        
        if (daysFilter) {
          daysFilter.addEventListener('change', loadEmployeesHistory);
        }
        
        if (refreshBtn) {
          refreshBtn.addEventListener('click', loadEmployeesHistory);
        }
        
        // Load data
        loadEmployeesHistory();
      });
    </script>
</body>
</html>
